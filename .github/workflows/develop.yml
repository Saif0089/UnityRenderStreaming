name: Develop - Deployment

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: Delta-mesh
    environment: develop
    env:
      SERVICE_NAME: webapp.service
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        clean: false

    - name: Make all .sh files executable
      run: find . -name "*.sh" -exec chmod +x {} \;

    - name: Create log directory
      run: |
        echo ${{ secrets.ROOT_PASSWORD }} | sudo -S mkdir -p /var/log/webapp
        echo ${{ secrets.ROOT_PASSWORD }} | sudo -S chown $(whoami) /var/log/webapp

    - name: Create or update systemd service file
      run: |
        sudo -S bash -c "
        cat > /etc/systemd/system/$SERVICE_NAME << 'EOF'
        [Unit]
        Description=Web App Service
        After=network.target

        [Service]
        ExecStart=$(pwd)/test_webapp.sh ${{ secrets.DEVELOP_PORT }} >> /var/log/webapp/output.log 2>&1
        Restart=on-failure
        User=$(whoami)
        WorkingDirectory=$(pwd)

        [Install]
        WantedBy=multi-user.target
        EOF
        " <<< "${{ secrets.ROOT_PASSWORD }}"

    - name: Configure log rotation
      run: |
        sudo -S bash -c "
        cat > /etc/logrotate.d/webapp << 'EOF'
        /var/log/webapp/*.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          copytruncate
        }
        EOF
        " <<< "${{ secrets.ROOT_PASSWORD }}"

    - name: Reload systemd and restart service
      run: |
        sudo -S bash -c "
          systemctl daemon-reload
          systemctl unmask \$SERVICE_NAME || true
          systemctl stop \$SERVICE_NAME || echo 'Service not running'
          systemctl start \$SERVICE_NAME
          systemctl enable \$SERVICE_NAME
        " <<< "${{ secrets.ROOT_PASSWORD }}"